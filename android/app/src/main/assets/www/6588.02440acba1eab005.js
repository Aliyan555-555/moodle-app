"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6588],{46588:(e,t,a)=>{a.r(t),a.d(t,{AddonModGlossaryEditLazyModule:()=>H});var n=a(13386),o=a(83599),i=a(67643),s=a(84095),d=a(49671),r=a(56223),l=a(31381),c=a(64162),g=a(90030),m=a(43555),u=a(81370),p=a(53564),h=a(13010),_=a(34749),f=a(75803),y=a(10727),M=a(98370),A=a(40067),v=a(32971),E=a(2866),x=a(38799),Z=a(43468),w=a(19212),C=a(30242),G=a(96814),I=a(72399),T=a(66931),k=a(9340),b=a(8947),O=a(29657),P=a(22068),F=a(31903),D=a(15945),J=a(89515);const L=["editFormEl"];function AddonModGlossaryEditPage_h1_6_Template(e,t){if(1&e&&(w.TgZ(0,"h1"),w._UZ(1,"core-format-text",4),w.qZA()),2&e){const e=w.oxw();w.xp6(),w.Q6J("text",e.glossary.name)("contextInstanceId",e.cmId)("courseId",e.courseId)}}function AddonModGlossaryEditPage_form_9_ion_item_12_ion_select_option_6_Template(e,t){if(1&e&&(w.TgZ(0,"ion-select-option",13),w._uU(1),w.qZA()),2&e){const e=t.$implicit;w.Q6J("value",e.id),w.xp6(),w.hij(" ",e.name," ")}}const _c1=e=>({header:e});function AddonModGlossaryEditPage_form_9_ion_item_12_Template(e,t){if(1&e){const e=w.EpF();w.TgZ(0,"ion-item")(1,"ion-select",11),w.NdJ("ngModelChange",(function AddonModGlossaryEditPage_form_9_ion_item_12_Template_ion_select_ngModelChange_1_listener(t){w.CHM(e);const a=w.oxw(2);return w.KtG(a.data.categories=t)})),w.ALo(2,"translate"),w.ALo(3,"translate"),w.ALo(4,"translate"),w.ALo(5,"translate"),w.YNc(6,AddonModGlossaryEditPage_form_9_ion_item_12_ion_select_option_6_Template,2,2,"ion-select-option",12),w.qZA()()}if(2&e){const e=w.oxw(2);w.xp6(),w.Q6J("ngModel",e.data.categories)("placeholder",w.lcZ(2,6,"addon.mod_glossary.categories"))("cancelText",w.lcZ(3,8,"core.cancel"))("interfaceOptions",w.VKq(14,_c1,w.lcZ(4,10,"addon.mod_glossary.categories")))("label",w.lcZ(5,12,"addon.mod_glossary.categories")),w.xp6(5),w.Q6J("ngForOf",e.categories)}}function AddonModGlossaryEditPage_form_9_ion_item_13_Template(e,t){if(1&e){const e=w.EpF();w.TgZ(0,"ion-item")(1,"ion-textarea",14),w.NdJ("ngModelChange",(function AddonModGlossaryEditPage_form_9_ion_item_13_Template_ion_textarea_ngModelChange_1_listener(t){w.CHM(e);const a=w.oxw(2);return w.KtG(a.data.aliases=t)})),w.ALo(2,"translate"),w.qZA()()}if(2&e){const e=w.oxw(2);w.xp6(),w.Q6J("ngModel",e.data.aliases)("core-auto-rows",e.data.aliases)("label",w.lcZ(2,3,"addon.mod_glossary.aliases"))}}function AddonModGlossaryEditPage_form_9_ng_container_20_Template(e,t){if(1&e){const e=w.EpF();w.ynx(0),w.TgZ(1,"ion-item-divider")(2,"ion-label")(3,"h2"),w._uU(4),w.ALo(5,"translate"),w.qZA()()(),w.TgZ(6,"ion-item",15)(7,"ion-toggle",16),w.NdJ("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_20_Template_ion_toggle_ngModelChange_7_listener(t){w.CHM(e);const a=w.oxw(2);return w.KtG(a.data.usedynalink=t)})),w._uU(8),w.ALo(9,"translate"),w.qZA()(),w.TgZ(10,"ion-item",15)(11,"ion-toggle",17),w.NdJ("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_20_Template_ion_toggle_ngModelChange_11_listener(t){w.CHM(e);const a=w.oxw(2);return w.KtG(a.data.casesensitive=t)})),w._uU(12),w.ALo(13,"translate"),w.qZA()(),w.TgZ(14,"ion-item",15)(15,"ion-toggle",18),w.NdJ("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_20_Template_ion_toggle_ngModelChange_15_listener(t){w.CHM(e);const a=w.oxw(2);return w.KtG(a.data.fullmatch=t)})),w._uU(16),w.ALo(17,"translate"),w.qZA()(),w.BQk()}if(2&e){const e=w.oxw(2);w.xp6(4),w.Oqu(w.lcZ(5,9,"addon.mod_glossary.linking")),w.xp6(3),w.Q6J("ngModel",e.data.usedynalink),w.xp6(),w.hij(" ",w.lcZ(9,11,"addon.mod_glossary.entryusedynalink")," "),w.xp6(3),w.Q6J("disabled",!e.data.usedynalink)("ngModel",e.data.casesensitive),w.xp6(),w.hij(" ",w.lcZ(13,13,"addon.mod_glossary.casesensitive")," "),w.xp6(3),w.Q6J("disabled",!e.data.usedynalink)("ngModel",e.data.fullmatch),w.xp6(),w.hij(" ",w.lcZ(17,15,"addon.mod_glossary.fullmatch")," ")}}function AddonModGlossaryEditPage_form_9_Template(e,t){if(1&e){const e=w.EpF();w.TgZ(0,"form",null,5)(2,"ion-item")(3,"ion-input",6),w.NdJ("ngModelChange",(function AddonModGlossaryEditPage_form_9_Template_ion_input_ngModelChange_3_listener(t){w.CHM(e);const a=w.oxw();return w.KtG(a.data.concept=t)})),w.ALo(4,"translate"),w.ALo(5,"translate"),w.qZA()(),w.TgZ(6,"ion-item")(7,"ion-label",7),w._uU(8),w.ALo(9,"translate"),w.qZA(),w.TgZ(10,"core-rich-text-editor",8),w.NdJ("contentChanged",(function AddonModGlossaryEditPage_form_9_Template_core_rich_text_editor_contentChanged_10_listener(t){w.CHM(e);const a=w.oxw();return w.KtG(a.onDefinitionChange(t))})),w.ALo(11,"translate"),w.qZA()(),w.YNc(12,AddonModGlossaryEditPage_form_9_ion_item_12_Template,7,16,"ion-item",2)(13,AddonModGlossaryEditPage_form_9_ion_item_13_Template,3,5,"ion-item",2),w.TgZ(14,"ion-item-divider")(15,"ion-label")(16,"h2"),w._uU(17),w.ALo(18,"translate"),w.qZA()()(),w._UZ(19,"core-attachments",9),w.YNc(20,AddonModGlossaryEditPage_form_9_ng_container_20_Template,18,17,"ng-container",2),w.TgZ(21,"ion-button",10),w.NdJ("click",(function AddonModGlossaryEditPage_form_9_Template_ion_button_click_21_listener(){w.CHM(e);const t=w.oxw();return w.KtG(t.save())})),w._uU(22),w.ALo(23,"translate"),w.qZA()()}if(2&e){const e=w.oxw();w.xp6(3),w.Q6J("placeholder",w.lcZ(4,22,"addon.mod_glossary.concept"))("ngModel",e.data.concept)("label",w.lcZ(5,24,"addon.mod_glossary.concept")),w.xp6(5),w.Oqu(w.lcZ(9,26,"addon.mod_glossary.definition")),w.xp6(2),w.Q6J("control",e.definitionControl)("placeholder",w.lcZ(11,28,"addon.mod_glossary.definition"))("component",e.component)("componentId",e.cmId)("autoSave",!0)("contextInstanceId",e.cmId)("draftExtraParams",e.editorExtraParams),w.xp6(2),w.Q6J("ngIf",e.categories.length>0),w.xp6(),w.Q6J("ngIf",e.showAliases),w.xp6(4),w.Oqu(w.lcZ(18,30,"addon.mod_glossary.attachment")),w.xp6(2),w.Q6J("files",e.data.attachments)("component",e.component)("componentId",e.glossary.coursemodule)("allowOffline",!0)("courseId",e.courseId),w.xp6(),w.Q6J("ngIf",e.glossary.usedynalink),w.xp6(),w.Q6J("disabled",!e.data.concept||!e.data.definition),w.xp6(),w.hij(" ",w.lcZ(23,32,"core.save")," ")}}let Q=(()=>{var e;class AddonModGlossaryEditPage{constructor(e,t){this.route=e,this.splitView=t,this.component=v.eH.COMPONENT,this.loaded=!1,this.definitionControl=new r.NI(null),this.categories=[],this.showAliases=!0,this.editorExtraParams={},this.data={concept:"",definition:"",timecreated:0,attachments:[],categories:[],aliases:"",usedynalink:!1,casesensitive:!1,fullmatch:!1},this.isDestroyed=!1,this.saved=!1}ngOnInit(){var e=this;return(0,d.Z)((function*(){try{const t=m.b.getRouteParam("entrySlug");if(e.cmId=m.b.getRequiredRouteNumberParam("cmId"),e.courseId=m.b.getRequiredRouteNumberParam("courseId"),null!=t&&t.startsWith("new-")){const a=Number(t.slice(4));e.editorExtraParams.timecreated=a,e.handler=new AddonModGlossaryOfflineFormHandler(e,a)}else if(t){const{entry:a}=yield v.wi.getEntry(Number(t));e.entry=a,e.editorExtraParams.timecreated=a.timecreated,e.handler=new AddonModGlossaryOnlineFormHandler(e,a)}else e.handler=new AddonModGlossaryNewFormHandler(e)}catch(t){return h.OQ.showErrorModal(t),e.goBack(),void 0}e.fetchData()}))()}fetchData(){var e=this;return(0,d.Z)((function*(){try{if(e.glossary=yield v.wi.getGlossary(e.courseId,e.cmId),yield e.handler.loadData(e.glossary),e.loaded=!0,e.handler instanceof AddonModGlossaryOfflineFormHandler)return;Z.ke.logEvent({type:Z.gM.VIEW_ITEM,ws:"mod_glossary_get_glossaries_by_courses",name:e.glossary.name,data:{id:e.glossary.id,category:"glossary"},url:"/mod/glossary/edit.php"+(e.entry?`?cmid=${e.cmId}&id=${e.entry.id}`:"")})}catch(t){h.OQ.showErrorModalDefault(t,"addon.mod_glossary.errorloadingglossary",!0),e.goBack()}}))()}resetForm(){this.originalData=void 0,this.data.concept="",this.data.definition="",this.data.timecreated=0,this.data.categories=[],this.data.aliases="",this.data.usedynalink=!1,this.data.casesensitive=!1,this.data.fullmatch=!1,this.data.attachments.length=0,this.definitionControl.setValue("")}onDefinitionChange(e){this.data.definition=null!=e?e:""}canLeave(){var e=this;return(0,d.Z)((function*(){return e.saved||(e.hasDataChanged()&&(yield h.OQ.showConfirm(y.vN.instant("core.confirmcanceledit"))),g.b.clearTmpFiles(e.data.attachments),A.o.triggerFormCancelledEvent(e.formElement,p.m9.getCurrentSiteId())),!0}))()}save(){var e=this;return(0,d.Z)((function*(){if(!e.data.concept||!e.data.definition)return h.OQ.showErrorModal("addon.mod_glossary.fillfields",!0),void 0;if(!e.glossary)return;const t=yield h.OQ.showModalLoading("core.sending",!0);try{const t=yield e.handler.save(e.glossary);e.saved=!0,A.o.triggerFormSubmittedEvent(e.formElement,t,p.m9.getCurrentSiteId()),e.goBack()}catch(e){h.OQ.showErrorModalDefault(e,"addon.mod_glossary.cannoteditentry",!0)}finally{t.dismiss()}}))()}hasDataChanged(){return this.originalData&&void 0!==this.originalData.concept?this.originalData.definition!=this.data.definition||this.originalData.concept!=this.data.concept||g.b.areFileListDifferent(this.data.attachments,this.originalData.attachments):!!(this.data.definition||this.data.concept||this.data.attachments.length>0)}goBack(){var e;null!==(e=this.splitView)&&void 0!==e&&e.outletActivated?m.b.navigate("../../"):m.b.back()}}return(e=AddonModGlossaryEditPage).ɵfac=function AddonModGlossaryEditPage_Factory(t){return new(t||e)(w.Y36(i.gz),w.Y36(C.A,8))},e.ɵcmp=w.Xpm({type:e,selectors:[["page-addon-mod-glossary-edit"]],viewQuery:function AddonModGlossaryEditPage_Query(e,t){if(1&e&&w.Gf(L,5),2&e){let e;w.iGM(e=w.CRH())&&(t.formElement=e.first)}},decls:10,vars:6,consts:[["slot","start"],[3,"text"],[4,"ngIf"],[3,"hideUntil"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["editFormEl",""],["labelPlacement","stacked","type","text","name","concept",3,"placeholder","ngModel","label","ngModelChange"],["position","stacked"],["name","addon_mod_glossary_edit","contextLevel","module","elementId","definition_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams","contentChanged"],[3,"files","component","componentId","allowOffline","courseId"],["expand","block",1,"ion-margin",3,"disabled","click"],["labelPlacement","stacked","multiple","true","interface","action-sheet","name","categories",3,"ngModel","placeholder","cancelText","interfaceOptions","label","ngModelChange"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["labelPlacement","stacked","rows","1","name","aliases",3,"ngModel","core-auto-rows","label","ngModelChange"],[1,"ion-text-wrap"],["name","usedynalink",3,"ngModel","ngModelChange"],["name","casesensitive",3,"disabled","ngModel","ngModelChange"],["name","fullmatch",3,"disabled","ngModel","ngModelChange"]],template:function AddonModGlossaryEditPage_Template(e,t){1&e&&(w.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),w._UZ(3,"ion-back-button",1),w.ALo(4,"translate"),w.qZA(),w.TgZ(5,"ion-title"),w.YNc(6,AddonModGlossaryEditPage_h1_6_Template,2,3,"h1",2),w.qZA()()(),w.TgZ(7,"ion-content")(8,"core-loading",3),w.YNc(9,AddonModGlossaryEditPage_form_9_Template,24,34,"form",2),w.qZA()()),2&e&&(w.xp6(3),w.Q6J("text",w.lcZ(4,4,"core.back")),w.xp6(3),w.Q6J("ngIf",t.glossary),w.xp6(2),w.Q6J("hideUntil",t.loaded),w.xp6(),w.Q6J("ngIf",t.glossary))},dependencies:[G.sg,G.O5,I.J,T.r,k.k,b.r,O.t,P.O,r._Y,r.JJ,r.JL,r.On,r.F,F.YG,F.Sm,F.W2,F.Gu,F.pK,F.Ie,F.rH,F.Q$,F.t9,F.n0,F.g2,F.wd,F.ho,F.sr,F.w,F.QI,F.j9,F.oU,D.$,J.X$],encapsulation:2}),AddonModGlossaryEditPage})();class AddonModGlossaryFormHandler{constructor(e){this.page=e}loadCategories(e){var t=this;return(0,d.Z)((function*(){t.page.categories=yield v.wi.getAllCategories(e.id,{cmId:t.page.cmId})}))()}uploadAttachments(e){var t=this;return(0,d.Z)((function*(){const a=t.page.data;return yield g.b.uploadOrReuploadFiles(a.attachments,v.eH.COMPONENT,e.id)}))()}storeAttachments(e,t){var a=this;return(0,d.Z)((function*(){const n=a.page.data;return yield E.D.storeFiles(e.id,n.concept,t,n.attachments)}))()}checkDuplicates(e){var t=this;return(0,d.Z)((function*(){if(e.allowduplicatedentries)return;const a=t.page.data;if(yield v.wi.isConceptUsed(e.id,a.concept,{timeCreated:a.timecreated,cmId:t.page.cmId}))throw new l.G(y.vN.instant("addon.mod_glossary.errconceptalreadyexists"))}))()}getSaveOptions(e){const t=this.page.data,a={};return this.page.showAliases&&(a.aliases=t.aliases),this.page.categories.length>0&&(a.categories=t.categories.join(",")),e.usedynalink&&(a.usedynalink=t.usedynalink?1:0,t.usedynalink&&(a.casesensitive=t.casesensitive?1:0,a.fullmatch=t.fullmatch?1:0)),a}}class AddonModGlossaryOfflineFormHandler extends AddonModGlossaryFormHandler{constructor(e,t){super(e),this.timecreated=t}loadData(e){var t=this;return(0,d.Z)((function*(){var a;const n=t.page.data,o=yield x.s.getOfflineEntry(e.id,t.timecreated);var i,s,d;(n.concept=o.concept||"",n.definition=o.definition||"",n.timecreated=o.timecreated,o.options)&&(n.categories=(null!==(i=null===(s=o.options.categories)||void 0===s?void 0:s.split(","))&&void 0!==i?i:[]).map((e=>Number(e))),n.aliases=null!==(d=o.options.aliases)&&void 0!==d?d:"",n.usedynalink=!!o.options.usedynalink,n.usedynalink&&(n.casesensitive=!!o.options.casesensitive,n.fullmatch=!!o.options.fullmatch));null!==(a=o.attachments)&&void 0!==a&&a.offline&&(n.attachments=yield E.D.getStoredFiles(e.id,o.concept,o.timecreated)),t.page.originalData={concept:n.concept,definition:n.definition,attachments:n.attachments.slice(),timecreated:n.timecreated,categories:n.categories.slice(),aliases:n.aliases,usedynalink:n.usedynalink,casesensitive:n.casesensitive,fullmatch:n.fullmatch},t.page.definitionControl.setValue(n.definition),yield t.loadCategories(e)}))()}save(e){var t=this;return(0,d.Z)((function*(){const a=t.page.data,n=t.page.data;let o;return n.attachments.length&&(o=yield t.storeAttachments(e,n.timecreated)),a.concept!==n.concept&&(yield E.D.deleteStoredFiles(e.id,a.concept,n.timecreated)),yield t.updateOfflineEntry(e,o),g.b.clearTmpFiles(n.attachments),!1}))()}updateOfflineEntry(e,t){var a=this;return(0,d.Z)((function*(){const n=a.page.originalData,o=a.page.data,i=a.getSaveOptions(e),s=_._1.formatHtmlLines(o.definition);n&&(yield a.checkDuplicates(e),yield x.s.updateOfflineEntry({glossaryid:e.id,courseid:a.page.courseId,concept:n.concept,timecreated:n.timecreated},o.concept,s,i,t))}))()}}class AddonModGlossaryNewFormHandler extends AddonModGlossaryFormHandler{loadData(e){var t=this;return(0,d.Z)((function*(){yield t.loadCategories(e)}))()}save(e){var t=this;return(0,d.Z)((function*(){const a=t.page.data,n=Date.now();let o,i;if(a.attachments.length)try{o=yield t.uploadAttachments(e)}catch(a){if(f.Tr.isWebServiceError(a))throw a;i=yield t.storeAttachments(e,n)}const s=i?yield t.createOfflineEntry(e,n,i):yield t.createOnlineEntry(e,n,o,!a.attachments.length);return g.b.clearTmpFiles(a.attachments),s&&(E.D.deleteStoredFiles(e.id,a.concept,n),M.R.trigger(M.R.ACTIVITY_DATA_SENT,{module:"glossary"})),!!s}))()}createOfflineEntry(e,t,a){var n=this;return(0,d.Z)((function*(){const o=n.page.data,i=n.getSaveOptions(e),s=_._1.formatHtmlLines(o.definition);yield n.checkDuplicates(e),yield x.s.addOfflineEntry(e.id,o.concept,s,n.page.courseId,t,i,a,void 0,void 0)}))()}createOnlineEntry(e,t,a,n){var o=this;return(0,d.Z)((function*(){const i=o.page.data,s=o.getSaveOptions(e),d=_._1.formatHtmlLines(i.definition);return yield v.wi.addEntry(e.id,i.concept,d,o.page.courseId,s,a,{timeCreated:t,allowOffline:n,checkDuplicates:!e.allowduplicatedentries})}))()}}class AddonModGlossaryOnlineFormHandler extends AddonModGlossaryFormHandler{constructor(e,t){super(e),this.entry=t}loadData(){var e=this;return(0,d.Z)((function*(){const t=e.page.data;t.concept=e.entry.concept,t.definition=e.entry.definition||"",t.timecreated=e.entry.timecreated,t.usedynalink=e.entry.usedynalink,t.usedynalink&&(t.casesensitive=e.entry.casesensitive,t.fullmatch=e.entry.fullmatch),e.entry.attachments&&(t.attachments=e.entry.attachments),e.page.originalData={concept:t.concept,definition:t.definition,attachments:t.attachments.slice(),timecreated:t.timecreated,categories:t.categories.slice(),aliases:t.aliases,usedynalink:t.usedynalink,casesensitive:t.casesensitive,fullmatch:t.fullmatch},e.page.definitionControl.setValue(t.definition),e.page.showAliases=!1}))()}save(e){var t=this;return(0,d.Z)((function*(){if(!u.AS.isOnline())throw new c.k;const a=t.page.data,n=t.getSaveOptions(e),o=_._1.formatHtmlLines(a.definition);let i;return a.attachments.length&&(i=yield t.uploadAttachments(e)),yield v.wi.updateEntry(e.id,t.entry.id,a.concept,o,n,i),g.b.clearTmpFiles(a.attachments),M.R.trigger(M.R.ACTIVITY_DATA_SENT,{module:"glossary"}),!0}))()}}const N=[{path:"",component:Q,canDeactivate:[s.Y]}];let H=(()=>{var e;class AddonModGlossaryEditLazyModule{}return(e=AddonModGlossaryEditLazyModule).ɵfac=function AddonModGlossaryEditLazyModule_Factory(t){return new(t||e)},e.ɵmod=w.oAB({type:e}),e.ɵinj=w.cJS({imports:[i.Bz.forChild(N),n.L,o.I]}),AddonModGlossaryEditLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&w.kYT(H,{declarations:[Q],imports:[i.Bz,n.L,o.I]}))}}]);