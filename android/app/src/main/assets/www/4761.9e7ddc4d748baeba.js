"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4761],{74761:(e,o,s)=>{s.r(o),s.d(o,{AddonModWorkshopLazyModule:()=>ae});var t=s(67643),n=s(84095),a=s(13386),i=s(98712),r=s(43555),d=s(58107),l=s(19212),c=s(8947),m=s(60067),u=s(29657),h=s(31903),p=s(89515);let g=(()=>{var e;class AddonModWorkshopIndexPage extends i.S{constructor(){super(...arguments),this.selectedGroup=0}ngOnInit(){super.ngOnInit(),this.selectedGroup=r.b.getRouteNumberParam("group")||0}}return(e=AddonModWorkshopIndexPage).ɵfac=(()=>{let o;return function AddonModWorkshopIndexPage_Factory(s){return(o||(o=l.n5z(e)))(s||e)}})(),e.ɵcmp=l.Xpm({type:e,selectors:[["page-addon-mod-workshop-index"]],viewQuery:function AddonModWorkshopIndexPage_Query(e,o){if(1&e&&l.Gf(d.AddonModWorkshopIndexComponent,5),2&e){let e;l.iGM(e=l.CRH())&&(o.activityComponent=e.first)}},features:[l.qOj],decls:14,vars:13,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"module","courseId","group","dataRetrieved"]],template:function AddonModWorkshopIndexPage_Template(e,o){1&e&&(l.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),l._UZ(3,"ion-back-button",2),l.ALo(4,"translate"),l.qZA(),l.TgZ(5,"ion-title")(6,"h1"),l._UZ(7,"core-format-text",3),l.qZA()(),l._UZ(8,"ion-buttons",4),l.qZA()(),l.TgZ(9,"ion-content",5)(10,"ion-refresher",6),l.NdJ("ionRefresh",(function AddonModWorkshopIndexPage_Template_ion_refresher_ionRefresh_10_listener(e){return null==o.activityComponent?null:o.activityComponent.doRefresh(e.target)})),l._UZ(11,"ion-refresher-content",7),l.ALo(12,"translate"),l.qZA(),l.TgZ(13,"addon-mod-workshop-index",8),l.NdJ("dataRetrieved",(function AddonModWorkshopIndexPage_Template_addon_mod_workshop_index_dataRetrieved_13_listener(e){return o.updateData(e)})),l.qZA()()),2&e&&(l.xp6(3),l.Q6J("text",l.lcZ(4,9,"core.back")),l.xp6(4),l.Q6J("text",o.title)("contextInstanceId",o.module.id)("courseId",o.courseId),l.xp6(3),l.Q6J("disabled",null==o.activityComponent?null:o.activityComponent.showLoading),l.xp6(),l.s9C("pullingText",l.lcZ(12,11,"core.pulltorefresh")),l.xp6(2),l.Q6J("module",o.module)("courseId",o.courseId)("group",o.selectedGroup))},dependencies:[c.r,m.e,u.t,h.Sm,h.W2,h.Gu,h.nJ,h.Wo,h.wd,h.sr,h.oU,d.AddonModWorkshopIndexComponent,p.X$],encapsulation:2}),AddonModWorkshopIndexPage})();var f=s(63446),_=s(58346),k=s(83599),A=s(49671),I=s(56223),v=s(73180),w=s(4496),b=s(45151),x=s(53564),M=s(12265),W=s(13010),y=s(34749),T=s(10727),Z=s(98370),P=s(40067),S=s(78452),q=s(11850),E=s(63294),Q=s(3641),O=s(88817),J=s(43468),L=s(1248),D=s(96814),U=s(66931),R=s(80571),F=s(80070),C=s(22068),G=s(85904),N=s(15945);const Y=["evaluateFormEl"];function AddonModWorkshopAssessmentPage_ion_refresher_13_Template(e,o){if(1&e){const e=l.EpF();l.TgZ(0,"ion-refresher",15),l.NdJ("ionRefresh",(function AddonModWorkshopAssessmentPage_ion_refresher_13_Template_ion_refresher_ionRefresh_0_listener(o){l.CHM(e);const s=l.oxw();return l.KtG(s.refreshAssessment(o.target))})),l._UZ(1,"ion-refresher-content",16),l.ALo(2,"translate"),l.qZA()}if(2&e){const e=l.oxw();l.Q6J("disabled",!e.loaded),l.xp6(),l.s9C("pullingText",l.lcZ(2,2,"core.pulltorefresh"))}}function AddonModWorkshopAssessmentPage_core_user_avatar_16_Template(e,o){if(1&e&&l._UZ(0,"core-user-avatar",17),2&e){const e=l.oxw();l.Q6J("user",e.profile)("courseId",e.courseId)("userId",e.profile.id)}}function AddonModWorkshopAssessmentPage_h2_18_Template(e,o){if(1&e&&(l.TgZ(0,"h2"),l._uU(1),l.qZA()),2&e){const e=l.oxw();l.xp6(),l.Oqu(e.profile.fullname)}}const _c1=e=>({$a:e});function AddonModWorkshopAssessmentPage_p_19_Template(e,o){if(1&e&&(l.TgZ(0,"p"),l._uU(1),l.ALo(2,"translate"),l.qZA()),2&e){const e=l.oxw();l.xp6(),l.AsE(" ",l.xi3(2,2,"addon.mod_workshop.submissiongradeof",l.VKq(5,_c1,e.workshop.grade)),": ",e.assessment.grade," ")}}function AddonModWorkshopAssessmentPage_p_20_Template(e,o){if(1&e&&(l.TgZ(0,"p"),l._uU(1),l.ALo(2,"translate"),l.qZA()),2&e){const e=l.oxw();l.ekj("core-has-overriden-grade",e.showGrade(e.assessment.gradinggrade)),l.xp6(),l.AsE(" ",l.xi3(2,4,"addon.mod_workshop.gradinggradeof",l.VKq(7,_c1,e.workshop.gradinggrade)),": ",e.assessment.gradinggrade," ")}}function AddonModWorkshopAssessmentPage_p_21_Template(e,o){if(1&e&&(l.TgZ(0,"p",18),l._uU(1),l.ALo(2,"translate"),l.qZA()),2&e){const e=l.oxw();l.xp6(),l.AsE(" ",l.lcZ(2,2,"addon.mod_workshop.gradinggradeover"),": ",e.assessment.gradinggradeover," ")}}function AddonModWorkshopAssessmentPage_p_22_Template(e,o){if(1&e&&(l.TgZ(0,"p"),l._uU(1),l.ALo(2,"translate"),l.qZA()),2&e){const e=l.oxw();l.xp6(),l.hij(" ",l.xi3(2,1,"addon.mod_workshop.weightinfo",l.VKq(4,_c1,e.assessment.weight))," ")}}function AddonModWorkshopAssessmentPage_ion_badge_23_Template(e,o){1&e&&(l.TgZ(0,"ion-badge",19),l._uU(1),l.ALo(2,"translate"),l.qZA()),2&e&&(l.xp6(),l.hij(" ",l.lcZ(2,1,"addon.mod_workshop.notassessed")," "))}function AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template(e,o){if(1&e&&l._UZ(0,"addon-mod-workshop-assessment-strategy",20),2&e){const e=l.oxw();l.Q6J("workshop",e.workshop)("access",e.access)("assessmentId",e.assessmentId)("userId",e.profile&&e.profile.id)("strategy",e.strategy)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_7_Template(e,o){if(1&e&&(l.TgZ(0,"ion-select-option",28),l._uU(1),l.qZA()),2&e){const e=o.$implicit;l.Q6J("value",e),l.xp6(),l.Oqu(e)}}const _c2=e=>({header:e});function AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template(e,o){if(1&e&&(l.TgZ(0,"ion-item",7)(1,"ion-select",25),l.ALo(2,"translate"),l.ALo(3,"translate"),l.TgZ(4,"div",26),l._uU(5),l.ALo(6,"translate"),l.qZA(),l.YNc(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_7_Template,2,2,"ion-select-option",27),l.qZA()()),2&e){const e=l.oxw(2);l.xp6(),l.Q6J("cancelText",l.lcZ(2,5,"core.cancel"))("interfaceOptions",l.VKq(11,_c2,l.lcZ(3,7,"addon.mod_workshop.assessmentweight"))),l.xp6(3),l.Q6J("core-mark-required",!0),l.xp6(),l.hij(" ",l.lcZ(6,9,"addon.mod_workshop.assessmentweight")," "),l.xp6(2),l.Q6J("ngForOf",e.weights)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_5_Template(e,o){if(1&e&&(l.TgZ(0,"ion-select-option",28),l._uU(1),l.qZA()),2&e){const e=o.$implicit;l.Q6J("value",e.value),l.xp6(),l.hij(" ",e.label," ")}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template(e,o){if(1&e&&(l.TgZ(0,"ion-item",7)(1,"ion-select",29),l.ALo(2,"translate"),l.ALo(3,"translate"),l.ALo(4,"translate"),l.YNc(5,AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_5_Template,2,2,"ion-select-option",27),l.qZA()()),2&e){const e=l.oxw(2);l.xp6(),l.Q6J("cancelText",l.lcZ(2,4,"core.cancel"))("interfaceOptions",l.VKq(10,_c2,l.lcZ(3,6,"addon.mod_workshop.gradinggradeover")))("label",l.lcZ(4,8,"addon.mod_workshop.gradinggradeover")),l.xp6(4),l.Q6J("ngForOf",e.evaluationGrades)}}const _c3=e=>({asid:e});function AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template(e,o){if(1&e&&(l.TgZ(0,"ion-item")(1,"ion-label",30),l._uU(2),l.ALo(3,"translate"),l.qZA(),l._UZ(4,"core-rich-text-editor",31),l.qZA()),2&e){const e=l.oxw(2);l.xp6(2),l.Oqu(l.lcZ(3,5,"addon.mod_workshop.feedbackreviewer")),l.xp6(2),l.Q6J("control",e.evaluateForm.controls.text)("autoSave",!0)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("draftExtraParams",l.VKq(7,_c3,e.assessmentId))}}function AddonModWorkshopAssessmentPage_form_25_Template(e,o){if(1&e&&(l.TgZ(0,"form",21,22)(2,"ion-item",7)(3,"ion-label")(4,"h3",23),l._uU(5),l.ALo(6,"translate"),l.qZA()()(),l.YNc(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template,8,13,"ion-item",24),l.TgZ(8,"ion-item",7)(9,"ion-label")(10,"h3",23),l._uU(11),l.ALo(12,"translate"),l.qZA(),l.TgZ(13,"p"),l._uU(14),l.qZA()()(),l.YNc(15,AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template,6,12,"ion-item",24)(16,AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template,5,9,"ion-item",9),l.qZA()),2&e){const e=l.oxw();l.Q6J("formGroup",e.evaluateForm),l.xp6(5),l.Oqu(l.lcZ(6,7,"addon.mod_workshop.assessmentsettings")),l.xp6(2),l.Q6J("ngIf",null==e.access?null:e.access.canallocate),l.xp6(4),l.Oqu(l.lcZ(12,9,"addon.mod_workshop.gradinggradecalculated")),l.xp6(3),l.Oqu(e.gradingGrade),l.xp6(),l.Q6J("ngIf",null==e.access?null:e.access.canoverridegrades),l.xp6(),l.Q6J("ngIf",null==e.access?null:e.access.canoverridegrades)}}function AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template(e,o){if(1&e&&l._UZ(0,"core-user-avatar",17),2&e){const e=l.oxw(2);l.Q6J("user",e.evaluateByProfile)("courseId",e.courseId)("userId",e.evaluateByProfile.id)}}function AddonModWorkshopAssessmentPage_ion_list_26_h3_4_Template(e,o){if(1&e&&(l.TgZ(0,"h3",23),l._uU(1),l.ALo(2,"translate"),l.qZA()),2&e){const e=l.oxw(2);l.xp6(),l.hij(" ",l.xi3(2,1,"addon.mod_workshop.feedbackby",l.VKq(4,_c1,e.evaluateByProfile.fullname))," ")}}function AddonModWorkshopAssessmentPage_ion_list_26_Template(e,o){if(1&e&&(l.TgZ(0,"ion-list")(1,"ion-item",7),l.YNc(2,AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template,1,3,"core-user-avatar",8),l.TgZ(3,"ion-label"),l.YNc(4,AddonModWorkshopAssessmentPage_ion_list_26_h3_4_Template,3,6,"h3",32),l._UZ(5,"core-format-text",2),l.qZA()()()),2&e){const e=l.oxw();l.xp6(2),l.Q6J("ngIf",e.evaluateByProfile),l.xp6(2),l.Q6J("ngIf",e.evaluateByProfile&&e.evaluateByProfile.fullname),l.xp6(),l.Q6J("text",e.evaluate.text)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("courseId",e.courseId)}}let B=(()=>{var e;class AddonModWorkshopAssessmentPage{constructor(e){var o=this;this.fb=e,this.evaluating=!1,this.loaded=!1,this.title="",this.evaluate={text:"",grade:-1,weight:1},this.weights=[],this.evaluationGrades=[],this.originalEvaluation={text:"",grade:-1,weight:1},this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.siteId=x.m9.getCurrentSiteId(),this.currentUserId=x.m9.getCurrentSiteUserId(),this.showGrade=q.AddonModWorkshopHelper.showGrade,this.evaluateForm=new I.cw({}),this.evaluateForm.addControl("weight",this.fb.control("",I.kI.required)),this.evaluateForm.addControl("grade",this.fb.control("")),this.evaluateForm.addControl("text",this.fb.control("")),this.syncObserver=Z.R.on(Q.AddonModWorkshopSyncProvider.AUTO_SYNCED,(e=>{this.workshopId===e.workshopId&&(this.loaded=!1,this.refreshAllData())}),this.siteId),this.logView=O.V.once((0,A.Z)((function*(){o.workshop&&J.ke.logEvent({type:J.gM.VIEW_ITEM,ws:"mod_workshop_get_assessment",name:o.workshop.name,data:{id:o.workshop.id,assessmentid:o.assessment.id,category:"workshop"},url:`/mod/workshop/assessment.php?asid=${o.assessment.id}`})})))}ngOnInit(){try{this.assessment=r.b.getRequiredRouteParam("assessment"),this.submission=r.b.getRequiredRouteParam("submission"),this.profile=r.b.getRouteParam("profile"),this.courseId=r.b.getRequiredRouteNumberParam("courseId")}catch(e){return W.OQ.showErrorModal(e),r.b.back(),void 0}this.assessmentId=this.assessment.id,this.workshopId=this.submission.workshopid,this.fetchAssessmentData()}canLeave(){var e=this;return(0,A.Z)((function*(){return!(!e.forceLeave&&e.evaluating)||(!e.hasEvaluationChanged()||(yield W.OQ.showConfirm(T.vN.instant("core.confirmcanceledit")),P.o.triggerFormCancelledEvent(e.formElement,e.siteId),!0))}))()}fetchAssessmentData(){var e=this;return(0,A.Z)((function*(){try{var o,s;e.workshop=yield S.AddonModWorkshop.getWorkshopById(e.courseId,e.workshopId),e.title=e.workshop.name,e.strategy=e.workshop.strategy;const t=yield v.FO.getModuleBasicGradeInfo(e.workshop.coursemodule);if(e.maxGrade=null==t?void 0:t.grade,e.access=yield S.AddonModWorkshop.getWorkshopAccessInformation(e.workshopId,{cmId:e.workshop.coursemodule}),e.assessmentId&&(e.access.canallocate||e.access.canoverridegrades)?(e.isDestroyed||M.d.blockOperation(L.qR,e.workshopId),e.evaluating=!0):e.evaluating=!1,!e.evaluating&&e.workshop.phase!=S.AddonModWorkshopPhase.PHASE_CLOSED)return;const n=yield q.AddonModWorkshopHelper.getReviewerAssessmentById(e.workshopId,e.assessmentId,{userId:null===(o=e.profile)||void 0===o?void 0:o.id,cmId:e.workshop.coursemodule});if(e.assessment=q.AddonModWorkshopHelper.realGradeValue(e.workshop,n),e.evaluate.text=e.assessment.feedbackreviewer||"",e.evaluate.weight=e.assessment.weight,e.gradingGrade=null!==(s=e.assessment.gradinggrade)&&void 0!==s?s:"-",e.evaluating){if(e.access.canallocate){e.weights=[];for(let o=16;o>=0;o--)e.weights[o]=o}if(e.access.canoverridegrades){const o=T.vN.instant("addon.mod_workshop.notoverridden");e.evaluationGrades=yield w.b$.makeGradesMenu(e.workshop.gradinggrade,void 0,o,-1)}try{const o=yield E.AddonModWorkshopOffline.getEvaluateAssessment(e.workshopId,e.assessmentId);e.hasOffline=!0,e.evaluate.weight=o.weight,e.access.canoverridegrades&&(e.evaluate.text=o.feedbacktext||"",e.evaluate.grade=parseInt(o.gradinggradeover,10)||-1)}catch{e.hasOffline=!1,e.access.canoverridegrades&&(e.evaluate.text=e.assessment.feedbackreviewer||"",e.evaluate.grade=parseInt(String(e.assessment.gradinggradeover),10)||-1)}finally{e.originalEvaluation.weight=e.evaluate.weight,e.access.canoverridegrades&&(e.originalEvaluation.text=e.evaluate.text,e.originalEvaluation.grade=e.evaluate.grade),e.evaluateForm.controls.weight.setValue(e.evaluate.weight),e.access.canoverridegrades&&(e.evaluateForm.controls.grade.setValue(e.evaluate.grade),e.evaluateForm.controls.text.setValue(e.evaluate.text))}}else e.workshop.phase==S.AddonModWorkshopPhase.PHASE_CLOSED&&e.assessment.gradinggradeoverby&&(e.evaluateByProfile=yield b.My.getProfile(e.assessment.gradinggradeoverby,e.courseId,!0))}catch(e){W.OQ.showErrorModalDefault(e,"core.course.errorgetmodule",!0)}finally{e.loaded=!0}}))()}forceLeavePage(){this.forceLeave=!0,r.b.back()}hasEvaluationChanged(){if(!this.loaded||!this.evaluating)return!1;const e=this.evaluateForm.value;if(this.originalEvaluation.weight!=e.weight)return!0;if(this.access&&this.access.canoverridegrades){if(this.originalEvaluation.text!=e.text)return!0;if(this.originalEvaluation.grade!=e.grade)return!0}return!1}refreshAllData(){var e=this;return(0,A.Z)((function*(){const o=[];o.push(S.AddonModWorkshop.invalidateWorkshopData(e.courseId)),o.push(S.AddonModWorkshop.invalidateWorkshopAccessInformationData(e.workshopId)),o.push(S.AddonModWorkshop.invalidateReviewerAssesmentsData(e.workshopId)),e.assessmentId&&(o.push(S.AddonModWorkshop.invalidateAssessmentFormData(e.workshopId,e.assessmentId)),o.push(S.AddonModWorkshop.invalidateAssessmentData(e.workshopId,e.assessmentId)));try{yield Promise.all(o)}finally{Z.R.trigger(S.AddonModWorkshopProvider.ASSESSMENT_INVALIDATED,null,e.siteId),yield e.fetchAssessmentData()}}))()}refreshAssessment(e){this.loaded&&this.refreshAllData().finally((()=>{null==e||e.complete()}))}saveEvaluation(){var e=this;return(0,A.Z)((function*(){e.hasEvaluationChanged()&&(yield e.sendEvaluation()),e.forceLeavePage()}))()}sendEvaluation(){var e=this;return(0,A.Z)((function*(){const o=yield W.OQ.showModalLoading("core.sending",!0),s=e.evaluateForm.value,t=s.grade>=0?String(s.grade):"",n=y._1.formatHtmlLines(s.text);try{const o=yield S.AddonModWorkshop.evaluateAssessment(e.workshopId,e.assessmentId,e.courseId,n,s.weight,t);P.o.triggerFormSubmittedEvent(e.formElement,!!o,e.siteId);const a={workshopId:e.workshopId,assessmentId:e.assessmentId,userId:e.currentUserId};return S.AddonModWorkshop.invalidateAssessmentData(e.workshopId,e.assessmentId).finally((()=>{Z.R.trigger(S.AddonModWorkshopProvider.ASSESSMENT_SAVED,a,e.siteId)}))}catch(e){W.OQ.showErrorModalDefault(e,"Cannot save assessment evaluation")}finally{o.dismiss()}}))()}ngOnDestroy(){var e;this.isDestroyed=!0,null===(e=this.syncObserver)||void 0===e||e.off(),M.d.unblockOperation(L.qR,this.workshopId)}}return(e=AddonModWorkshopAssessmentPage).ɵfac=function AddonModWorkshopAssessmentPage_Factory(o){return new(o||e)(l.Y36(I.qu))},e.ɵcmp=l.Xpm({type:e,selectors:[["page-addon-mod-workshop-assessment-page"]],viewQuery:function AddonModWorkshopAssessmentPage_Query(e,o){if(1&e&&l.Gf(Y,5),2&e){let e;l.iGM(e=l.CRH())&&(o.formElement=e.first)}},decls:27,vars:22,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end",3,"hidden"],["fill","clear",3,"click"],["slot","fixed",3,"disabled","ionRefresh",4,"ngIf"],[3,"hideUntil"],[1,"ion-text-wrap"],["slot","start",3,"user","courseId","userId",4,"ngIf"],[4,"ngIf"],[3,"core-has-overriden-grade",4,"ngIf"],["class","core-overriden-grade",4,"ngIf"],["color","danger",4,"ngIf"],[3,"workshop","access","assessmentId","userId","strategy",4,"ngIf"],[3,"formGroup",4,"ngIf"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],["slot","start",3,"user","courseId","userId"],[1,"core-overriden-grade"],["color","danger"],[3,"workshop","access","assessmentId","userId","strategy"],[3,"formGroup"],["evaluateFormEl",""],[1,"item-heading"],["class","ion-text-wrap",4,"ngIf"],["labelPlacement","stacked","formControlName","weight","required","true","interface","action-sheet",3,"cancelText","interfaceOptions"],["slot","label",3,"core-mark-required"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["labelPlacement","stacked","formControlName","grade","interface","action-sheet",3,"cancelText","interfaceOptions","label"],["position","stacked"],["name","text","contextLevel","module","elementId","feedbackreviewer_editor",3,"control","autoSave","contextInstanceId","draftExtraParams"],["class","item-heading",4,"ngIf"]],template:function AddonModWorkshopAssessmentPage_Template(e,o){1&e&&(l.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),l._UZ(3,"ion-back-button",1),l.ALo(4,"translate"),l.qZA(),l.TgZ(5,"ion-title")(6,"h1"),l._UZ(7,"core-format-text",2),l.qZA()(),l.TgZ(8,"ion-buttons",3)(9,"ion-button",4),l.NdJ("click",(function AddonModWorkshopAssessmentPage_Template_ion_button_click_9_listener(){return o.saveEvaluation()})),l._uU(10),l.ALo(11,"translate"),l.qZA()()()(),l.TgZ(12,"ion-content"),l.YNc(13,AddonModWorkshopAssessmentPage_ion_refresher_13_Template,3,4,"ion-refresher",5),l.TgZ(14,"core-loading",6)(15,"ion-item",7),l.YNc(16,AddonModWorkshopAssessmentPage_core_user_avatar_16_Template,1,3,"core-user-avatar",8),l.TgZ(17,"ion-label"),l.YNc(18,AddonModWorkshopAssessmentPage_h2_18_Template,2,1,"h2",9)(19,AddonModWorkshopAssessmentPage_p_19_Template,3,7,"p",9)(20,AddonModWorkshopAssessmentPage_p_20_Template,3,9,"p",10)(21,AddonModWorkshopAssessmentPage_p_21_Template,3,4,"p",11)(22,AddonModWorkshopAssessmentPage_p_22_Template,3,6,"p",9)(23,AddonModWorkshopAssessmentPage_ion_badge_23_Template,3,3,"ion-badge",12),l.qZA()(),l.YNc(24,AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template,1,5,"addon-mod-workshop-assessment-strategy",13)(25,AddonModWorkshopAssessmentPage_form_25_Template,17,11,"form",14)(26,AddonModWorkshopAssessmentPage_ion_list_26_Template,6,5,"ion-list",9),l.qZA()()),2&e&&(l.xp6(3),l.Q6J("text",l.lcZ(4,18,"core.back")),l.xp6(4),l.Q6J("text",o.title)("contextInstanceId",o.workshop&&o.workshop.coursemodule)("courseId",o.courseId),l.xp6(),l.Q6J("hidden",!o.evaluating),l.xp6(2),l.hij(" ",l.lcZ(11,20,"core.save")," "),l.xp6(3),l.Q6J("ngIf",!o.evaluating),l.xp6(),l.Q6J("hideUntil",o.loaded),l.xp6(2),l.Q6J("ngIf",o.profile),l.xp6(2),l.Q6J("ngIf",o.profile&&o.profile.fullname),l.xp6(),l.Q6J("ngIf",o.workshop&&o.assessment&&o.showGrade(o.assessment.grade)),l.xp6(),l.Q6J("ngIf",o.workshop&&o.access&&o.access.canviewallsubmissions&&o.assessment&&o.showGrade(o.assessment.gradinggrade)),l.xp6(),l.Q6J("ngIf",o.access&&o.access.canviewallsubmissions&&o.assessment&&o.showGrade(o.assessment.gradinggradeover)),l.xp6(),l.Q6J("ngIf",o.assessment&&o.assessment.weight&&1!==o.assessment.weight),l.xp6(),l.Q6J("ngIf",!o.assessment||!o.showGrade(o.assessment.grade)),l.xp6(),l.Q6J("ngIf",o.assessment&&o.assessmentId&&o.showGrade(o.assessment.grade)&&o.workshop&&o.access),l.xp6(),l.Q6J("ngIf",o.evaluating),l.xp6(),l.Q6J("ngIf",!o.evaluating&&o.evaluate&&o.evaluate.text))},dependencies:[D.sg,D.O5,U.r,R.O,F.X,c.r,u.t,C.O,I._Y,I.JJ,I.JL,I.Q7,h.yp,h.YG,h.Sm,h.W2,h.Gu,h.Ie,h.Q$,h.q_,h.nJ,h.Wo,h.t9,h.n0,h.wd,h.sr,h.QI,h.oU,I.sg,I.u,G.W,N.$,p.X$],encapsulation:2}),AddonModWorkshopAssessmentPage})();var V=s(31381),H=s(90030),$=s(76474),j=s(65254),z=s(75803),X=s(72399);const K=["editFormEl"];function AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template(e,o){if(1&e&&(l.TgZ(0,"ion-item")(1,"ion-label",13)(2,"div",14),l._uU(3),l.ALo(4,"translate"),l.qZA()(),l._UZ(5,"core-rich-text-editor",15),l.ALo(6,"translate"),l.qZA()),2&e){const e=l.oxw(2);l.xp6(2),l.Q6J("core-mark-required",e.textRequired),l.xp6(),l.hij(" ",l.lcZ(4,9,"addon.mod_workshop.submissioncontent")," "),l.xp6(2),l.Q6J("control",e.editForm.controls.content)("placeholder",l.lcZ(6,11,"addon.mod_workshop.submissioncontent"))("component",e.component)("componentId",e.componentId)("autoSave",!0)("contextInstanceId",e.module.id)("draftExtraParams",e.editorExtraParams)}}function AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template(e,o){if(1&e&&l._UZ(0,"core-attachments",16),2&e){const e=l.oxw(2);l.Q6J("files",e.attachments)("maxSize",e.workshop.maxbytes)("maxSubmissions",e.workshop.nattachments)("component",e.component)("componentId",e.workshop.coursemodule)("acceptedTypes",e.workshop.submissionfiletypes)("required",e.fileRequired)("courseId",e.workshop.course)}}function AddonModWorkshopEditSubmissionPage_form_16_Template(e,o){if(1&e&&(l.TgZ(0,"form",6,7)(2,"ion-item",8)(3,"ion-input",9),l.ALo(4,"translate"),l.TgZ(5,"div",10),l._uU(6),l.ALo(7,"translate"),l.qZA()()(),l.YNc(8,AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template,7,13,"ion-item",11)(9,AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template,1,8,"core-attachments",12),l.qZA()),2&e){const e=l.oxw();l.Q6J("formGroup",e.editForm),l.xp6(3),l.Q6J("placeholder",l.lcZ(4,6,"addon.mod_workshop.submissiontitle")),l.xp6(2),l.Q6J("core-mark-required",!0),l.xp6(),l.hij(" ",l.lcZ(7,8,"addon.mod_workshop.submissiontitle")," "),l.xp6(2),l.Q6J("ngIf",e.textAvailable),l.xp6(),l.Q6J("ngIf",e.fileAvailable)}}let ee=(()=>{var e;class AddonModWorkshopEditSubmissionPage{constructor(e){this.fb=e,this.loaded=!1,this.component=L.qR,this.editorExtraParams={},this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.attachments=[],this.submissionId=0,this.originalData={title:"",content:"",attachmentfiles:[]},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.userId=x.m9.getCurrentSiteUserId(),this.siteId=x.m9.getCurrentSiteId(),this.editForm=new I.cw({}),this.editForm.addControl("title",this.fb.control("",I.kI.required)),this.editForm.addControl("content",this.fb.control(""))}ngOnInit(){try{this.module=r.b.getRequiredRouteParam("module"),this.courseId=r.b.getRequiredRouteNumberParam("courseId"),this.access=r.b.getRequiredRouteParam("access"),this.submissionId=r.b.getRouteNumberParam("submissionId")||0}catch(e){return W.OQ.showErrorModal(e),r.b.back(),void 0}this.submissionId>0&&(this.editorExtraParams.id=this.submissionId),this.workshopId=this.module.instance,this.componentId=this.module.id,this.isDestroyed||M.d.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()}canLeave(){var e=this;return(0,A.Z)((function*(){var o;return e.forceLeave||(e.hasDataChanged()&&(yield W.OQ.showConfirm(T.vN.instant("core.confirmcanceledit"))),null!==(o=e.submission)&&void 0!==o&&o.attachmentfiles&&H.b.clearTmpFiles(e.submission.attachmentfiles),P.o.triggerFormCancelledEvent(e.formElement,e.siteId)),!0}))()}fetchSubmissionData(){var e=this;return(0,A.Z)((function*(){try{if(e.workshop=yield S.AddonModWorkshop.getWorkshop(e.courseId,e.module.id),e.textAvailable=e.workshop.submissiontypetext!=S.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_DISABLED,e.textRequired=e.workshop.submissiontypetext==S.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_REQUIRED,e.fileAvailable=e.workshop.submissiontypefile!=S.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_DISABLED,e.fileRequired=e.workshop.submissiontypefile==S.AddonModWorkshopSubmissionType.SUBMISSION_TYPE_REQUIRED,e.editForm.controls.content.setValidators(e.textRequired?I.kI.required:null),e.submissionId>0){e.editing=!0,e.submission=yield q.AddonModWorkshopHelper.getSubmissionById(e.workshopId,e.submissionId,{cmId:e.module.id});if(!(e.userId==e.submission.authorid&&e.access.cansubmit&&e.access.modifyingsubmissionallowed))return e.forceLeavePage(),void 0}else if(!e.access.cansubmit||!e.access.creatingsubmissionallowed)return e.forceLeavePage(),void 0;const o=yield E.AddonModWorkshopOffline.getSubmissions(e.workshopId);o&&o.length?(e.hasOffline=!0,e.submission=yield q.AddonModWorkshopHelper.applyOfflineData(e.submission,o)):e.hasOffline=!1,e.submission&&(e.originalData.title=e.submission.title||"",e.originalData.content=e.submission.content||"",e.originalData.attachmentfiles=[],(e.submission.attachmentfiles||[]).forEach((o=>{let s=$.l.getFileName(o);s||(s=j.X.getFilenameFromPath(o)||""),e.originalData.attachmentfiles.push({filename:s,fileurl:"fileurl"in o?o.fileurl:""})})),e.editForm.controls.title.setValue(e.submission.title),e.editForm.controls.content.setValue(e.submission.content),e.attachments=e.submission.attachmentfiles||[]),e.loaded=!0,e.logView()}catch(o){e.loaded=!1,W.OQ.showErrorModalDefault(o,"core.course.errorgetmodule",!0),e.forceLeavePage()}}))()}logView(){this.workshop&&J.ke.logEvent({type:J.gM.VIEW_ITEM,ws:this.editing?"mod_workshop_update_submission":"mod_workshop_add_submission",name:this.workshop.name,data:{id:this.workshop.id,submissionid:this.submissionId,category:"workshop"},url:`/mod/workshop/submission.php?cmid=${this.module.id}&id=${this.submissionId}&edit=on`})}forceLeavePage(){this.forceLeave=!0,r.b.back()}getInputData(){const e={title:this.editForm.value.title,content:"",attachmentfiles:[]};return this.textAvailable&&(e.content=this.editForm.value.content||""),this.fileAvailable&&(e.attachmentfiles=this.attachments),e}hasDataChanged(){if(!this.loaded)return!1;const e=this.getInputData();return!!(this.originalData.title!=e.title||this.textAvailable&&this.originalData.content!=e.content)||!!this.fileAvailable&&H.b.areFileListDifferent(e.attachmentfiles,this.originalData.attachmentfiles)}save(){var e=this;return(0,A.Z)((function*(){if(e.hasDataChanged())try{yield e.saveSubmission(),e.forceLeavePage()}catch{}else e.forceLeavePage()}))()}saveSubmission(){var e=this;return(0,A.Z)((function*(){var o;const s=e.getInputData();if(!s.title)throw W.OQ.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),new V.G(T.vN.instant("addon.mod_workshop.submissionrequiredtitle"));const t=y._1.htmlIsBlank(s.content),n=!s.attachmentfiles.length;if(e.textRequired&&t||e.fileRequired&&n||t&&n)throw W.OQ.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),new V.G(T.vN.instant("addon.mod_workshop.submissionrequiredcontent"));let a=!1;const i=yield W.OQ.showModalLoading("core.sending",!0),r=null===(o=e.submission)||void 0===o?void 0:o.id;e.textAvailable&&(s.content=y._1.formatHtmlLines(s.content));let d=!s.attachmentfiles.length;try{let o,t,n;try{o=yield q.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,s.attachmentfiles,!1)}catch(o){if(z.Tr.isWebServiceError(o))throw o;a=!0,d=!0,t=yield q.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,s.attachmentfiles,!0)}if(a||e.fileAvailable||(o=void 0),e.editing)if(a)yield E.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,s.title,s.content,t,r,S.AddonModWorkshopAction.UPDATE),n=!1;else{if(!r)throw new V.G("Submission cannot be updated without a submissionId");n=yield S.AddonModWorkshop.updateSubmission(e.workshopId,r,e.courseId,s.title,s.content,o,void 0,d)}else a?(yield E.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,s.title,s.content,t,void 0,S.AddonModWorkshopAction.ADD),n=!1):n=yield S.AddonModWorkshop.addSubmission(e.workshopId,e.courseId,s.title,s.content,o,void 0,d);P.o.triggerFormSubmittedEvent(e.formElement,!!n,e.siteId);const i={workshopId:e.workshopId};n&&(E.AddonModWorkshopOffline.deleteSubmissionAction(e.workshopId,e.editing?S.AddonModWorkshopAction.UPDATE:S.AddonModWorkshopAction.ADD),q.AddonModWorkshopHelper.deleteSubmissionStoredFiles(e.workshopId,e.siteId),i.submissionId=n),Z.R.trigger(Z.R.ACTIVITY_DATA_SENT,{module:"workshop"});const l=n?S.AddonModWorkshop.invalidateSubmissionData(e.workshopId,n):Promise.resolve();yield l.finally((()=>{Z.R.trigger(S.AddonModWorkshopProvider.SUBMISSION_CHANGED,i,e.siteId),H.b.clearTmpFiles(s.attachmentfiles)}))}catch(e){W.OQ.showErrorModalDefault(e,"Cannot save submission")}finally{i.dismiss()}}))()}getFilesComponentId(){return this.workshopId+"_"+(this.submissionId>0?this.submissionId:"newsub")}ngOnDestroy(){this.isDestroyed=!0,M.d.unblockOperation(this.component,this.workshopId)}}return(e=AddonModWorkshopEditSubmissionPage).ɵfac=function AddonModWorkshopEditSubmissionPage_Factory(o){return new(o||e)(l.Y36(I.qu))},e.ɵcmp=l.Xpm({type:e,selectors:[["page-addon-mod-workshop-edit-submission"]],viewQuery:function AddonModWorkshopEditSubmissionPage_Query(e,o){if(1&e&&l.Gf(K,5),2&e){let e;l.iGM(e=l.CRH())&&(o.formElement=e.first)}},decls:17,vars:14,consts:[["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["editFormEl",""],[1,"ion-text-wrap"],["labelPlacement","stacked","name","title","type","text","formControlName","title",3,"placeholder"],["slot","label",3,"core-mark-required"],[4,"ngIf"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId",4,"ngIf"],["position","stacked"],[3,"core-mark-required"],["name","content","contextLevel","module","elementId","content_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId"]],template:function AddonModWorkshopEditSubmissionPage_Template(e,o){1&e&&(l.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),l._UZ(3,"ion-back-button",1),l.ALo(4,"translate"),l.qZA(),l.TgZ(5,"ion-title")(6,"h1"),l._uU(7),l.ALo(8,"translate"),l.qZA()(),l.TgZ(9,"ion-buttons",2)(10,"ion-button",3),l.NdJ("click",(function AddonModWorkshopEditSubmissionPage_Template_ion_button_click_10_listener(){return o.save()})),l.ALo(11,"translate"),l._uU(12),l.ALo(13,"translate"),l.qZA()()()(),l.TgZ(14,"ion-content")(15,"core-loading",4),l.YNc(16,AddonModWorkshopEditSubmissionPage_form_16_Template,10,10,"form",5),l.qZA()()),2&e&&(l.xp6(3),l.Q6J("text",l.lcZ(4,6,"core.back")),l.xp6(4),l.Oqu(l.lcZ(8,8,"addon.mod_workshop.editsubmission")),l.xp6(3),l.uIk("aria-label",l.lcZ(11,10,"core.save")),l.xp6(2),l.hij(" ",l.lcZ(13,12,"core.save")," "),l.xp6(3),l.Q6J("hideUntil",o.loaded),l.xp6(),l.Q6J("ngIf",o.workshop))},dependencies:[D.O5,X.J,U.r,R.O,u.t,C.O,I._Y,I.JJ,I.JL,h.YG,h.Sm,h.W2,h.Gu,h.pK,h.Ie,h.Q$,h.wd,h.sr,h.j9,h.oU,I.sg,I.u,N.$,p.X$],encapsulation:2}),AddonModWorkshopEditSubmissionPage})();var oe=s(86700),se=s(78025),te=s(3330);const ne=[{path:":courseId/:cmId",component:g},{path:":courseId/:cmId/:submissionId",component:_.B,canDeactivate:[n.Y]},{path:":courseId/:cmId/:submissionId/edit",component:ee,canDeactivate:[n.Y]},{path:":courseId/:cmId/:submissionId/:assessmentId",component:B,canDeactivate:[n.Y]}];let ae=(()=>{var e;class AddonModWorkshopLazyModule{}return(e=AddonModWorkshopLazyModule).ɵfac=function AddonModWorkshopLazyModule_Factory(o){return new(o||e)},e.ɵmod=l.oAB({type:e}),e.ɵinj=l.cJS({imports:[t.Bz.forChild(ne),a.L,f.AddonModWorkshopComponentsModule,k.I]}),AddonModWorkshopLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&l.kYT(ae,{declarations:[g,_.B,B,ee],imports:[t.Bz,a.L,f.AddonModWorkshopComponentsModule,k.I]})),l.B6R(_.B,(function(){return[D.sg,D.O5,U.r,F.X,oe.I,c.r,u.t,C.O,I._Y,I.JJ,I.JL,h.YG,h.Sm,h.W2,h.Gu,h.gu,h.Ie,h.Q$,h.q_,h.nJ,h.Wo,h.t9,h.n0,h.wd,h.ho,h.sr,h.w,h.QI,h.oU,I.sg,I.u,se.W,te.X,G.W,N.$]}),(function(){return[p.X$]}))}}]);