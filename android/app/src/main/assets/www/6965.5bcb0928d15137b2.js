"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6965],{36965:(e,i,t)=>{t.r(i),t.d(i,{AddonModWikiLazyModule:()=>J});var o=t(67643),d=t(13386),n=t(69858),r=t(3448),a=t(83599),s=t(84095),l=t(49671),c=t(31381),g=t(73180),u=t(43555),I=t(53564),m=t(12265),p=t(13010),k=t(34749),w=t(75803),f=t(10727),h=t(98370),b=t(40067),_=t(17389),v=t(74611),P=t(11508),E=t(43468),T=t(19212),x=t(56223),y=t(96814),A=t(66931),L=t(8947),M=t(29657),Z=t(22068),C=t(31903),N=t(15945),O=t(89515);const W=["editPageForm"];function AddonModWikiEditPage_form_14_ion_item_2_Template(e,i){1&e&&(T.TgZ(0,"ion-item",13),T._UZ(1,"ion-input",14),T.ALo(2,"translate"),T.ALo(3,"translate"),T.qZA()),2&e&&(T.xp6(),T.Q6J("placeholder",T.lcZ(3,4,"addon.mod_wiki.newpagetitle")),T.uIk("aria-label",T.lcZ(2,2,"addon.mod_wiki.newpagetitle")))}function AddonModWikiEditPage_form_14_ion_item_9_Template(e,i){1&e&&(T.TgZ(0,"ion-item",15)(1,"ion-label")(2,"ion-badge",16),T._uU(3),T.ALo(4,"translate"),T.qZA()()()),2&e&&(T.xp6(3),T.Oqu(T.lcZ(4,1,"addon.mod_wiki.wrongversionlock")))}function AddonModWikiEditPage_form_14_Template(e,i){if(1&e&&(T.TgZ(0,"form",7,8),T.YNc(2,AddonModWikiEditPage_form_14_ion_item_2_Template,4,6,"ion-item",9),T.TgZ(3,"ion-item")(4,"ion-label",10),T._uU(5),T.ALo(6,"translate"),T.qZA(),T._UZ(7,"core-rich-text-editor",11),T.ALo(8,"translate"),T.qZA(),T.YNc(9,AddonModWikiEditPage_form_14_ion_item_9_Template,5,3,"ion-item",12),T.qZA()),2&e){const e=T.oxw();T.Q6J("formGroup",e.pageForm),T.xp6(2),T.Q6J("ngIf",e.canEditTitle),T.xp6(3),T.Oqu(T.lcZ(6,11,"core.content")),T.xp6(2),T.Q6J("control",e.contentControl)("placeholder",T.lcZ(8,13,"core.content"))("component",e.component)("componentId",e.cmId)("autoSave",!0)("contextInstanceId",e.cmId)("draftExtraParams",e.editorExtraParams),T.xp6(2),T.Q6J("ngIf",e.wrongVersionLock)}}let F=(()=>{var e;class AddonModWikiEditPage{constructor(e){this.formBuilder=e,this.canEditTitle=!1,this.loaded=!1,this.component=_.L.COMPONENT,this.wrongVersionLock=!1,this.editorExtraParams={},this.editing=!1,this.editOffline=!1,this.subwikiFiles=[],this.forceLeave=!1,this.isDestroyed=!1,this.contentControl=this.formBuilder.control("",{nonNullable:!0}),this.pageForm=this.formBuilder.group({})}ngOnInit(){var e=this;return(0,l.Z)((function*(){e.cmId=u.b.getRouteNumberParam("cmId")||void 0,e.courseId=u.b.getRouteNumberParam("courseId")||void 0,e.subwikiId=u.b.getRouteNumberParam("subwikiId"),e.wikiId=u.b.getRouteNumberParam("wikiId"),e.pageId=u.b.getRouteNumberParam("pageId"),e.section=u.b.getRouteParam("section"),e.groupId=u.b.getRouteNumberParam("groupId"),e.userId=u.b.getRouteNumberParam("userId");const i=u.b.getRouteParam("pageTitle");e.originalTitle=i?k._1.cleanTags(i.replace(/\+/g," "),{singleLine:!0}):"",e.canEditTitle=!e.originalTitle,e.title=e.originalTitle?f.vN.instant("addon.mod_wiki.editingpage",{$a:e.originalTitle}):f.vN.instant("addon.mod_wiki.newpagehdr"),e.blockId=P.p.getSubwikiBlockId(e.subwikiId,e.wikiId,e.userId,e.groupId),e.pageForm.addControl("title",e.formBuilder.control(e.originalTitle)),e.pageForm.addControl("text",e.contentControl),m.d.blockOperation(e.component,e.blockId),e.pageId?(e.editorExtraParams.pageid=e.pageId,e.section&&(e.editorExtraParams.section=e.section)):e.originalTitle&&(e.editorExtraParams.pagetitle=e.originalTitle);try{if((yield e.fetchWikiPageData())&&!e.isDestroyed){const i=P.p.getSubwikiBlockId(e.subwikiId,e.wikiId,e.userId,e.groupId);i!==e.blockId&&(m.d.unblockOperation(e.component,e.blockId),e.blockId=i,m.d.blockOperation(e.component,e.blockId)),e.logView()}}finally{e.loaded=!0}}))()}fetchWikiPageData(){var e=this;return(0,l.Z)((function*(){let i=!1,t=!1;try{const t=e.blockId?yield P.p.waitForSync(e.blockId):void 0;if(e.pageId){e.canEditTitle=!1,e.editing=!0,e.editOffline=!1;const t=yield _.x.getPageContents(e.pageId,{cmId:e.cmId});e.pageForm.controls.title.setValue(t.title),e.wikiId=t.wikiid,e.subwikiId=t.subwikiid,e.title=f.vN.instant("addon.mod_wiki.editingpage",{$a:t.title}),e.originalTitle=t.title,e.groupId=t.groupid,e.userId=t.userid,i=t.caneditpage,yield e.fetchModuleAndCourseId(),e.subwikiFiles=yield _.x.getSubwikiFiles(e.wikiId,{groupId:e.groupId,userId:e.userId,cmId:e.cmId});const o=yield _.x.getPageForEditing(e.pageId,e.section),d=k._1.replacePluginfileUrls(o.content||"",e.subwikiFiles);e.contentControl.setValue(d),e.originalContent=d,e.version=o.version,i&&(e.renewLockInterval=window.setInterval((()=>{e.renewLock()}),_.L.RENEW_LOCK_TIME))}else{const o=e.pageForm.controls.title.value;if(e.editing=!1,i=!!e.blockId,yield e.fetchModuleAndCourseId(),!e.wikiId&&e.cmId&&e.courseId){const i=yield g.FO.getModule(e.cmId,e.courseId,void 0,!0);e.wikiId=i.instance}if(o){if(t){const i=t.created.find((e=>e.title==o));if(i&&i.pageId>0)return e.pageId=i.pageId,e.fetchWikiPageData()}const i=yield w.Tr.ignoreErrors(v.k.getNewPage(o,e.subwikiId,e.wikiId,e.userId,e.groupId));i?(e.contentControl.setValue(i.cachedcontent),e.originalContent=i.cachedcontent,e.editOffline=!0):e.editOffline=!1}else e.editOffline=!1}return!0}catch(i){return p.OQ.showErrorModalDefault(i,"Error getting wiki data."),t=!0,e.forceLeavePage(),!1}finally{i||t||(p.OQ.showAlert(f.vN.instant("core.notice"),f.vN.instant("addon.mod_wiki.cannoteditpage")),e.forceLeavePage())}}))()}fetchModuleAndCourseId(){var e=this;return(0,l.Z)((function*(){if(!e.wikiId||e.cmId&&e.courseId)return;const i=yield g.FO.getModuleBasicInfoByInstance(e.wikiId,"wiki",{readingStrategy:1});e.cmId=i.id,e.courseId=i.course}))()}forceLeavePage(){this.forceLeave=!0,u.b.back()}goToPage(e){this.wikiId&&(_.x.setEditedPageData({cmId:this.cmId,courseId:this.courseId,pageId:this.pageId,pageTitle:e,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}),this.forceLeavePage())}hasDataChanged(){const e=this.pageForm.value;return!(this.originalContent==e.text||!this.editing&&!e.text&&!e.title)}canLeave(){var e=this;return(0,l.Z)((function*(){return e.forceLeave||(e.hasDataChanged()&&(yield p.OQ.showConfirm(f.vN.instant("core.confirmcanceledit"))),b.o.triggerFormCancelledEvent(e.formElement,I.m9.getCurrentSiteId())),!0}))()}ionViewDidLeave(){setTimeout((()=>{_.x.consumeEditedPageData()}),200)}save(){var e=this;return(0,l.Z)((function*(){var i;const t=e.pageForm.value,o=t.title;let d=null!==(i=t.text)&&void 0!==i?i:"";const n=yield p.OQ.showModalLoading("core.sending",!0);d=k._1.restorePluginfileUrls(d,e.subwikiFiles),d=k._1.formatHtmlLines(d);try{if(e.editing&&e.pageId)return yield _.x.editPage(e.pageId,d,e.section),b.o.triggerFormSubmittedEvent(e.formElement,!0,I.m9.getCurrentSiteId()),yield _.x.invalidatePage(e.pageId),e.goToPage(o);if(!o)return n.dismiss(),p.OQ.showAlert(f.vN.instant("core.notice"),f.vN.instant("addon.mod_wiki.titleshouldnotbeempty")),void 0;if(!e.editOffline){if(yield w.Tr.ignoreErrors(v.k.getNewPage(o,e.subwikiId,e.wikiId,e.userId,e.groupId)))throw new c.G(f.vN.instant("addon.mod_wiki.pageexists"))}const i=yield _.x.newPage(o,d,{subwikiId:e.subwikiId,wikiId:e.wikiId,userId:e.userId,groupId:e.groupId,cmId:e.cmId});if(b.o.triggerFormSubmittedEvent(e.formElement,i>0,I.m9.getCurrentSiteId()),i<=0)return e.goToPage(o);h.R.trigger(h.R.ACTIVITY_DATA_SENT,{module:"wiki"}),e.pageId=i;const t=yield _.x.getPageContents(e.pageId,{cmId:e.cmId}),r=[];e.wikiId=t.wikiid,r.push(_.x.invalidateSubwikiPages(e.wikiId)),e.subwikiId||r.push(_.x.invalidateSubwikis(e.wikiId)),e.subwikiId=t.subwikiid,e.userId=t.userid,e.groupId=t.groupid,yield w.Tr.ignoreErrors(Promise.all(r)),h.R.trigger(_.L.PAGE_CREATED_EVENT,{pageId:e.pageId,subwikiId:e.subwikiId,pageTitle:o},I.m9.getCurrentSiteId()),e.goToPage(o)}catch(e){p.OQ.showErrorModalDefault(e,"Error saving wiki data.")}finally{n.dismiss()}}))()}renewLock(){var e=this;return(0,l.Z)((function*(){if(!e.pageId)return;const i=yield _.x.getPageForEditing(e.pageId,e.section,!0);i.version&&e.version!=i.version&&(e.wrongVersionLock=!0)}))()}logView(){var e;let i;if(this.pageId)i=`/mod/wiki/edit.php?pageid=${this.pageId}`+(this.section?`&section=${this.section.replace(/ /g,"+")}`:"");else if(this.originalTitle){const e=this.originalTitle.replace(/ /g,"+");var t,o;if(this.subwikiId)i=`/mod/wiki/create.php?swid=${this.subwikiId}&title=${e}&action=new`;else i=`/mod/wiki/create.php?wid=${this.wikiId}&group=${null!==(t=this.groupId)&&void 0!==t?t:0}&uid=${null!==(o=this.userId)&&void 0!==o?o:0}&title=${e}`}else i=`/mod/wiki/create.php?action=new&wid=${this.wikiId}&swid=${this.subwikiId}`;E.ke.logEvent({type:E.gM.VIEW_ITEM,ws:this.pageId?"mod_wiki_edit_page":"mod_wiki_new_page",name:null!==(e=this.originalTitle)&&void 0!==e?e:f.vN.instant("addon.mod_wiki.newpagehdr"),data:{id:this.wikiId,subwiki:this.subwikiId,category:"wiki"},url:i})}ngOnDestroy(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&m.d.unblockOperation(this.component,this.blockId)}}return(e=AddonModWikiEditPage).ɵfac=function AddonModWikiEditPage_Factory(i){return new(i||e)(T.Y36(x.qu))},e.ɵcmp=T.Xpm({type:e,selectors:[["page-addon-mod-wiki-edit"]],viewQuery:function AddonModWikiEditPage_Query(e,i){if(1&e&&T.Gf(W,5),2&e){let e;T.iGM(e=T.CRH())&&(i.formElement=e.first)}},decls:15,vars:11,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["editPageForm",""],["class","ion-text-wrap",4,"ngIf"],[1,"sr-only"],["name","wiki_page_content","contextLevel","module","elementId","newcontent_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["class","ion-text-center addon-mod_wiki-wrongversionlock",4,"ngIf"],[1,"ion-text-wrap"],["name","title","type","text","formControlName","title",3,"placeholder"],[1,"ion-text-center","addon-mod_wiki-wrongversionlock"],["color","danger",1,"ion-padding"]],template:function AddonModWikiEditPage_Template(e,i){1&e&&(T.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),T._UZ(3,"ion-back-button",1),T.ALo(4,"translate"),T.qZA(),T.TgZ(5,"ion-title")(6,"h1"),T._UZ(7,"core-format-text",2),T.qZA()(),T.TgZ(8,"ion-buttons",3)(9,"ion-button",4),T.NdJ("click",(function AddonModWikiEditPage_Template_ion_button_click_9_listener(){return i.save()})),T._uU(10),T.ALo(11,"translate"),T.qZA()()()(),T.TgZ(12,"ion-content")(13,"core-loading",5),T.YNc(14,AddonModWikiEditPage_form_14_Template,10,15,"form",6),T.qZA()()),2&e&&(T.xp6(3),T.Q6J("text",T.lcZ(4,7,"core.back")),T.xp6(4),T.Q6J("text",i.title)("contextInstanceId",i.cmId)("courseId",i.courseId),T.xp6(3),T.hij(" ",T.lcZ(11,9,"core.save")," "),T.xp6(3),T.Q6J("hideUntil",i.loaded),T.xp6(),T.Q6J("ngIf",i.loaded))},dependencies:[y.O5,A.r,L.r,M.t,Z.O,x._Y,x.JJ,x.JL,C.yp,C.YG,C.Sm,C.W2,C.Gu,C.pK,C.Ie,C.Q$,C.wd,C.sr,C.j9,C.oU,x.sg,x.u,N.$,O.X$],encapsulation:2}),AddonModWikiEditPage})();var S=t(60067),Q=t(70241);const D=[{path:":courseId/:cmId",redirectTo:":courseId/:cmId/page/root"},{path:":courseId/:cmId/page/:hash",component:r.i},{path:":courseId/:cmId/edit",component:F,canDeactivate:[s.Y]}];let J=(()=>{var e;class AddonModWikiLazyModule{}return(e=AddonModWikiLazyModule).ɵfac=function AddonModWikiLazyModule_Factory(i){return new(i||e)},e.ɵmod=T.oAB({type:e}),e.ɵinj=T.cJS({imports:[o.Bz.forChild(D),d.L,n.K,a.I]}),AddonModWikiLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&T.kYT(J,{declarations:[r.i,F],imports:[o.Bz,d.L,n.K,a.I]})),T.B6R(r.i,(function(){return[L.r,S.e,M.t,C.Sm,C.W2,C.Gu,C.nJ,C.Wo,C.wd,C.sr,C.oU,Q.k]}),(function(){return[O.X$]}))}}]);