"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[248],{80248:(e,o,t)=>{t.r(o),t.d(o,{AddonModBookLazyModule:()=>z});var n=t(67643),a=t(13386),d=t(57404),r=t(98712),i=t(82540),s=t(19212),l=t(8947),c=t(60067),u=t(29657),p=t(31903),g=t(89515);let m=(()=>{var e;class AddonModBookIndexPage extends r.S{}return(e=AddonModBookIndexPage).ɵfac=(()=>{let o;return function AddonModBookIndexPage_Factory(t){return(o||(o=s.n5z(e)))(t||e)}})(),e.ɵcmp=s.Xpm({type:e,selectors:[["page-addon-mod-book-index"]],viewQuery:function AddonModBookIndexPage_Query(e,o){if(1&e&&s.Gf(i.F,5),2&e){let e;s.iGM(e=s.CRH())&&(o.activityComponent=e.first)}},features:[s.qOj],decls:14,vars:12,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"module","courseId","dataRetrieved"]],template:function AddonModBookIndexPage_Template(e,o){1&e&&(s.TgZ(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),s._UZ(3,"ion-back-button",2),s.ALo(4,"translate"),s.qZA(),s.TgZ(5,"ion-title")(6,"h1"),s._UZ(7,"core-format-text",3),s.qZA()(),s._UZ(8,"ion-buttons",4),s.qZA()(),s.TgZ(9,"ion-content",5)(10,"ion-refresher",6),s.NdJ("ionRefresh",(function AddonModBookIndexPage_Template_ion_refresher_ionRefresh_10_listener(e){return null==o.activityComponent?null:o.activityComponent.doRefresh(e.target)})),s._UZ(11,"ion-refresher-content",7),s.ALo(12,"translate"),s.qZA(),s.TgZ(13,"addon-mod-book-index",8),s.NdJ("dataRetrieved",(function AddonModBookIndexPage_Template_addon_mod_book_index_dataRetrieved_13_listener(e){return o.updateData(e)})),s.qZA()()),2&e&&(s.xp6(3),s.Q6J("text",s.lcZ(4,8,"core.back")),s.xp6(4),s.Q6J("text",o.title)("contextInstanceId",o.module.id)("courseId",o.courseId),s.xp6(3),s.Q6J("disabled",null==o.activityComponent?null:o.activityComponent.showLoading),s.xp6(),s.s9C("pullingText",s.lcZ(12,10,"core.pulltorefresh")),s.xp6(2),s.Q6J("module",o.module)("courseId",o.courseId))},dependencies:[l.r,c.e,u.t,p.Sm,p.W2,p.Gu,p.nJ,p.Wo,p.wd,p.sr,p.oU,i.F,g.X$],encapsulation:2}),AddonModBookIndexPage})();var _=t(51845),h=t(49671),f=t(18005),I=t(31381),v=t(8944),k=t(9596),b=t(14881),M=t(73180),x=t(9588),C=t(76777),A=t(81370),Z=t(43555),T=t(13010),y=t(34749),w=t(75803),B=t(10727),P=t(63838),O=t(79817),J=t(43468),N=t(857),S=t(21450),L=t(96814),U=t(66931),R=t(81863),E=t(86700),Q=t(19289),q=t(22068),D=t(83779);function AddonModBookContentsPage_ion_button_9_Template(e,o){if(1&e){const e=s.EpF();s.TgZ(0,"ion-button",12),s.NdJ("click",(function AddonModBookContentsPage_ion_button_9_Template_ion_button_click_0_listener(){s.CHM(e);const o=s.oxw();return s.KtG(o.showToc())})),s.ALo(1,"translate"),s._UZ(2,"ion-icon",13),s.qZA()}2&e&&s.uIk("aria-label",s.lcZ(1,1,"addon.mod_book.toc"))}function AddonModBookContentsPage_ion_card_16_Template(e,o){if(1&e&&(s.TgZ(0,"ion-card",14)(1,"ion-item"),s._UZ(2,"ion-icon",15),s.TgZ(3,"ion-label"),s._UZ(4,"span",16),s.qZA()()()),2&e){const e=s.oxw();s.xp6(4),s.Q6J("innerHTML",e.warning,s.oJD)}}function AddonModBookContentsPage_ng_template_18_div_2_Template(e,o){if(1&e&&(s.TgZ(0,"div",20)(1,"strong"),s._uU(2),s.ALo(3,"translate"),s.qZA(),s._UZ(4,"core-tag-list",21),s.qZA()),2&e){const e=s.oxw().item;s.xp6(2),s.hij("",s.lcZ(3,2,"core.tag.tags"),": "),s.xp6(2),s.Q6J("tags",e.tags)}}function AddonModBookContentsPage_ng_template_18_Template(e,o){if(1&e&&(s.TgZ(0,"div",17),s._UZ(1,"core-format-text",18),s.YNc(2,AddonModBookContentsPage_ng_template_18_div_2_Template,5,4,"div",19),s.qZA()),2&e){const e=o.item,t=o.active,n=s.oxw();s.xp6(),s.Q6J("component",n.component)("componentId",n.cmId)("text",e.content)("contextInstanceId",n.cmId)("courseId",n.courseId)("disabled",!t),s.xp6(),s.Q6J("ngIf",(null==e.tags?null:e.tags.length)>0)}}function AddonModBookContentsPage_core_navigation_bar_19_Template(e,o){if(1&e){const e=s.EpF();s.TgZ(0,"core-navigation-bar",22),s.NdJ("action",(function AddonModBookContentsPage_core_navigation_bar_19_Template_core_navigation_bar_action_0_listener(o){s.CHM(e);const t=s.oxw();return s.KtG(t.changeChapter(o.id))})),s.qZA()}if(2&e){const e=s.oxw();s.Q6J("items",e.navigationItems)}}let F=(()=>{var e;class AddonModBookContentsPage{constructor(){this.title="",this.component=O.a.COMPONENT,this.warning="",this.displayNavBar=!0,this.navigationItems=[],this.swiperOpts={modules:[S.L$],autoHeight:!0,observer:!0,observeParents:!0,scrollOnChange:"top"},this.loaded=!1}ngOnInit(){try{this.cmId=Z.b.getRequiredRouteNumberParam("cmId"),this.courseId=Z.b.getRequiredRouteNumberParam("courseId"),this.initialChapterId=Z.b.getRouteNumberParam("chapterId")}catch(e){return T.OQ.showErrorModal(e),Z.b.back(),void 0}const e=new AddonModBookSlidesItemsManagerSource(this.courseId,this.cmId,C.e.areTagsAvailableInSite(),this.initialChapterId);this.manager=new v.I(e),this.managerUnsubscribe=this.manager.addListener({onSelectedItemUpdated:e=>{this.onChapterViewed(e.id)}}),this.fetchContent()}get module(){var e;return null===(e=this.manager)||void 0===e?void 0:e.getSource().module}get book(){var e;return null===(e=this.manager)||void 0===e?void 0:e.getSource().book}get chapters(){var e;return(null===(e=this.manager)||void 0===e?void 0:e.getSource().chapters)||[]}fetchContent(e=!1){var o=this;return(0,h.Z)((function*(){try{var t;const n=null===(t=o.manager)||void 0===t?void 0:t.getSource();if(!n)return;const{module:a,book:d}=yield n.loadBookData(),r=yield o.downloadResourceIfNeeded(a,e);if(o.displayNavBar=0!=d.navstyle,o.title=d.name,yield n.loadContents(),yield n.load(),null!=r&&r.failed){const e=y._1.getErrorMessageFromError(r.error)||r.error;o.warning=B.vN.instant("core.errordownloadingsomefiles")+(e?" "+e:"")}else o.warning=""}catch(e){T.OQ.showErrorModalDefault(e,"core.course.errorgetmodule",!0)}finally{o.loaded=!0}}))()}downloadResourceIfNeeded(e,o=!1){var t=this;return(0,h.Z)((function*(){var n;const a={failed:!1};let d=!1;if((yield x.e.getModuleStatus(e,t.courseId,void 0,o))!==f.i.DOWNLOADED)try{yield x.e.downloadModule(e,t.courseId),d=!0}catch(e){a.failed=!0,a.error=e}if(null===(n=e.contents)||void 0===n||!n.length||o&&!d){const t=o&&A.AS.isOnline();try{yield M.FO.loadModuleContents(e,void 0,void 0,!1,t)}catch(o){if(t&&!e.contents)yield M.FO.loadModuleContents(e);else if(!e.contents)throw o}}return a}))()}changeChapter(e){var o;e&&(null===(o=this.swipeSlidesComponent)||void 0===o||o.slideToItem({id:e}))}doRefresh(e){var o=this;return(0,h.Z)((function*(){o.manager&&(yield w.Tr.ignoreErrors(Promise.all([o.manager.getSource().invalidateContent(),x.e.invalidateCourseUpdates(o.courseId)]))),yield w.Tr.ignoreErrors(o.fetchContent(!0)),null==e||e.complete()}))()}showToc(){var e=this;return(0,h.Z)((function*(){var o;const t=null===(o=e.manager)||void 0===o?void 0:o.getSelectedItem(),n=yield T.OQ.openSideModal({component:P.r,componentProps:{moduleId:e.cmId,chapters:e.chapters,selected:null==t?void 0:t.id,courseId:e.courseId,book:e.book}});n&&e.changeChapter(n)}))()}onChapterViewed(e){var o=this;return(0,h.Z)((function*(){if(o.displayNavBar&&(o.navigationItems=o.getNavigationItems(e)),o.book&&O.u.storeLastChapterViewed(o.book.id,e,o.courseId),!o.module)return;yield w.Tr.ignoreErrors(O.u.logView(o.module.instance,e)),J.ke.logEvent({type:J.gM.VIEW_ITEM,ws:"mod_book_view_book",name:o.module.name,data:{id:o.module.instance,category:"book",chapterid:e},url:N.T.addParamsToUrl(`/mod/book/view.php?id=${o.module.id}`,{chapterid:e})});const t=o.chapters.findIndex((o=>o.id==e));(t<0||void 0===o.chapters[t+1])&&M.FO.checkModuleCompletion(o.courseId,o.module.completiondata)}))()}getNavigationItems(e){return this.chapters.map((o=>({item:o,title:o.title,current:o.id==e,enabled:!0})))}ngOnDestroy(){var e,o;null===(e=this.manager)||void 0===e||e.destroy(),null===(o=this.managerUnsubscribe)||void 0===o||o.call(this),delete this.manager}}return(e=AddonModBookContentsPage).ɵfac=function AddonModBookContentsPage_Factory(o){return new(o||e)},e.ɵcmp=s.Xpm({type:e,selectors:[["page-addon-mod-book-contents"]],viewQuery:function AddonModBookContentsPage_Query(e,o){if(1&e&&s.Gf(b.G,5),2&e){let e;s.iGM(e=s.CRH())&&(o.swipeSlidesComponent=e.first)}},decls:20,vars:16,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["aria-haspopup","true",3,"click",4,"ngIf"],["slot","fixed",3,"disabled","ionRefresh"],[3,"pullingText"],[3,"hideUntil"],[1,"safe-area-padding-horizontal","core-swipe-slides-container"],["class","core-warning-card",4,"ngIf"],[3,"manager","options"],["collapsible-footer","","appearOnBottom","","previousTranslate","addon.mod_book.navprevtitle","nextTranslate","addon.mod_book.navnexttitle","slot","fixed",3,"items","action",4,"ngIf"],["aria-haspopup","true",3,"click"],["name","fas-bookmark","slot","icon-only","aria-hidden","true"],[1,"core-warning-card"],["name","fas-triangle-exclamation","slot","start","aria-hidden","true"],[3,"innerHTML"],[1,"ion-padding"],["contextLevel","module",3,"component","componentId","text","contextInstanceId","courseId","disabled"],["class","ion-margin-top",4,"ngIf"],[1,"ion-margin-top"],[3,"tags"],["collapsible-footer","","appearOnBottom","","previousTranslate","addon.mod_book.navprevtitle","nextTranslate","addon.mod_book.navnexttitle","slot","fixed",3,"items","action"]],template:function AddonModBookContentsPage_Template(e,o){1&e&&(s.TgZ(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),s._UZ(3,"ion-back-button",1),s.ALo(4,"translate"),s.qZA(),s.TgZ(5,"ion-title")(6,"h1"),s._UZ(7,"core-format-text",2),s.qZA()(),s.TgZ(8,"ion-buttons",3),s.YNc(9,AddonModBookContentsPage_ion_button_9_Template,3,3,"ion-button",4),s.qZA()()(),s.TgZ(10,"ion-content")(11,"ion-refresher",5),s.NdJ("ionRefresh",(function AddonModBookContentsPage_Template_ion_refresher_ionRefresh_11_listener(e){return o.doRefresh(e.target)})),s._UZ(12,"ion-refresher-content",6),s.ALo(13,"translate"),s.qZA(),s.TgZ(14,"core-loading",7)(15,"div",8),s.YNc(16,AddonModBookContentsPage_ion_card_16_Template,5,1,"ion-card",9),s.TgZ(17,"core-swipe-slides",10),s.YNc(18,AddonModBookContentsPage_ng_template_18_Template,3,7,"ng-template"),s.qZA()()(),s.YNc(19,AddonModBookContentsPage_core_navigation_bar_19_Template,1,1,"core-navigation-bar",11),s.qZA()),2&e&&(s.xp6(3),s.Q6J("text",s.lcZ(4,12,"core.back")),s.xp6(4),s.Q6J("text",o.title)("contextInstanceId",o.cmId)("courseId",o.courseId),s.xp6(2),s.Q6J("ngIf",o.loaded),s.xp6(2),s.Q6J("disabled",!o.loaded),s.xp6(),s.s9C("pullingText",s.lcZ(13,14,"core.pulltorefresh")),s.xp6(2),s.Q6J("hideUntil",o.loaded),s.xp6(2),s.Q6J("ngIf",o.warning),s.xp6(),s.Q6J("manager",o.manager)("options",o.swiperOpts),s.xp6(2),s.Q6J("ngIf",o.loaded&&o.displayNavBar&&o.navigationItems.length>1))},dependencies:[L.O5,U.r,R.J,b.G,E.I,l.r,Q.u,u.t,q.O,p.YG,p.Sm,p.PM,p.W2,p.Gu,p.gu,p.Ie,p.Q$,p.nJ,p.Wo,p.wd,p.sr,p.oU,D.I,g.X$],styles:["[_nghost-%COMP%]   .core-swipe-slides-container[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]{flex:none}"]}),AddonModBookContentsPage})();class AddonModBookSlidesItemsManagerSource extends k.H{constructor(e,o,t,n){super(n?{id:n}:void 0),this.chapters=[],this.contentsMap={},this.COURSE_ID=e,this.CM_ID=o,this.TAGS_ENABLED=t}getItemId(e){return e.id}loadBookData(){var e=this;return(0,h.Z)((function*(){if(e.module=yield M.FO.getModule(e.CM_ID,e.COURSE_ID),e.book=yield O.u.getBook(e.COURSE_ID,e.CM_ID),!e.initialItem){const o=yield O.u.getLastChapterViewed(e.book.id);o&&(e.initialItem={id:o})}return{module:e.module,book:e.book}}))()}loadContents(){var e=this;return(0,h.Z)((function*(){if(!e.module)return;const o=yield M.FO.getModuleContents(e.module,e.COURSE_ID);e.contentsMap=O.u.getContentsMap(o),e.chapters=O.u.getTocList(o)}))()}loadItems(){var e=this;return(0,h.Z)((function*(){try{const o=yield Promise.all(e.chapters.map(function(){var o=(0,h.Z)((function*(o){const t=yield O.u.getChapterContent(e.contentsMap,o.id,e.CM_ID);return{id:o.id,content:t,tags:e.TAGS_ENABLED?e.contentsMap[o.id].tags:[]}}));return function(e){return o.apply(this,arguments)}}()));return o}catch(e){if(!y._1.getErrorMessageFromError(e))throw new I.G(B.vN.instant("addon.mod_book.errorchapter"));throw e}}))()}invalidateContent(){return O.u.invalidateContent(this.CM_ID,this.COURSE_ID)}}const G=[{path:":courseId/:cmId",component:m},{path:":courseId/:cmId/contents",component:F}];let z=(()=>{var e;class AddonModBookLazyModule{}return(e=AddonModBookLazyModule).ɵfac=function AddonModBookLazyModule_Factory(o){return new(o||e)},e.ɵmod=s.oAB({type:e}),e.ɵinj=s.cJS({imports:[n.Bz.forChild(G),a.L,d.q,_.g]}),AddonModBookLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&s.kYT(z,{declarations:[m,F],imports:[n.Bz,a.L,d.q,_.g]}))}}]);